<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>考古辨識-原生驅動版</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #1a1a1a; color: white; margin: 0; padding: 20px; }
        #video-container { position: relative; width: 300px; height: 300px; margin: 15px auto; border: 4px solid #ffcc00; border-radius: 15px; overflow: hidden; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { display: none; } /* 隱藏用來計算的畫布 */
        #result-card { background: #333; padding: 15px; border-radius: 10px; margin: 15px auto; max-width: 300px; }
        #label { font-size: 1.5rem; font-weight: bold; color: #ffcc00; }
        .btn { background: #ffcc00; color: #000; border: none; padding: 15px 35px; font-size: 1.2rem; font-weight: bold; border-radius: 10px; cursor: pointer; }
        #log { font-size: 0.7rem; color: #777; margin-top: 10px; }
    </style>
</head>
<body>

    <h2>考古文化 AI 辨識</h2>
    
    <div id="video-container">
        <video id="webcam-video" autoplay playsinline muted></video>
    </div>

    <div id="result-card">
        <div id="label">等待啟動</div>
        <div id="prob">準確率: 0%</div>
    </div>

    <button class="btn" id="start-btn" onclick="startSystem()">啟動辨識系統</button>
    
    <div id="log">系統狀態：準備就緒</div>

    <script>
        const MODEL_URL = "https://teachablemachine.withgoogle.com/models/[...]";
        let model, video, labelContainer, probContainer;

        async function startSystem() {
            video = document.getElementById('webcam-video');
            const log = document.getElementById('log');
            const btn = document.getElementById('start-btn');
            labelContainer = document.getElementById('label');
            probContainer = document.getElementById('prob');

            btn.disabled = true;
            btn.innerHTML = "啟動中...";
            log.innerHTML = "正在請求鏡頭權限...";

            try {
                // 1. 先開啟鏡頭 (使用你上次成功的原生語法)
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" }, 
                    audio: false 
                });
                video.srcObject = stream;
                log.innerHTML = "鏡頭已開啟，正在載入 AI 模型...";

                // 2. 載入 AI 模型
                model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
                
                log.innerHTML = "✅ 系統運作中";
                btn.style.display = "none";

                // 3. 開始辨識迴圈
                predict();

            } catch (err) {
                log.innerHTML = "❌ 失敗: " + err.message;
                btn.disabled = false;
                btn.innerHTML = "重新啟動";
            }
        }

        async function predict() {
            // 從 Video 標籤抓取影像進行辨識
            const prediction = await model.predict(video);
            
            prediction.sort((a, b) => b.probability - a.probability);
            const top = prediction[0];

            labelContainer.innerHTML = top.className;
            probContainer.innerHTML = "準確率: " + (top.probability * 100).toFixed(0) + "%";

            // 持續執行
            requestAnimationFrame(predict);
        }
    </script>
</body>
</html>

