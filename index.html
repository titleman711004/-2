<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>考古辨識系統-測試版</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #121212; color: white; margin: 0; padding: 20px; }
        #webcam-container { margin: 15px auto; width: 300px; height: 300px; border: 4px solid #444; border-radius: 15px; overflow: hidden; background: #000; position: relative; }
        canvas { width: 100% !important; height: 100% !important; object-fit: cover; }
        #result-box { background: #252525; padding: 15px; border-radius: 10px; margin: 20px auto; max-width: 300px; border-left: 5px solid #ffcc00; }
        #label { font-size: 1.6rem; font-weight: bold; color: #ffcc00; }
        #conf { font-size: 0.9rem; color: #888; margin-top: 5px; }
        .btn { background: #ffcc00; color: #000; border: none; padding: 15px 40px; font-size: 1.1rem; font-weight: bold; border-radius: 50px; cursor: pointer; }
        #status-log { font-size: 0.7rem; color: #666; margin-top: 20px; }
    </style>
</head>
<body>

    <h2 style="color:#ffcc00;">考古文化 AI 辨識</h2>
    <p style="font-size:0.8rem; color:#bbb;">請對準陶片，系統將自動分析紋飾特徵</p>

    <div id="webcam-container"></div>

    <div id="result-box">
        <div id="label">等待啟動</div>
        <div id="conf">辨識準確度: 0%</div>
    </div>

    <button class="btn" id="start-btn" onclick="init()">啟動 AI 辨識</button>
    
    <div id="status-log">系統狀態：準備就緒</div>

    <script type="text/javascript">
        // 此連結為 Google 官方穩定測試模型
        const URL = "https://teachablemachine.withgoogle.com/models/v8L_B9_S/";

        let model, webcam, labelContainer, confContainer, maxPredictions;

        async function init() {
            document.getElementById("status-log").innerHTML = "正在載入 AI 模型...";
            document.getElementById("start-btn").style.display = "none";

            try {
                // 1. 載入模型檔案
                model = await tmImage.load(URL + "model.json", URL + "metadata.json");
                maxPredictions = model.getTotalClasses();

                // 2. 初始化鏡頭
                const flip = false; 
                webcam = new tmImage.Webcam(300, 300, flip); 
                
                // 3. 請求權限並設定後鏡頭
                await webcam.setup({ facingMode: "environment" }); 
                
                // 4. 重要：修正手機 Video 標籤屬性
                const video = webcam.webcam;
                video.setAttribute('playsinline', 'true');
                video.setAttribute('muted', 'true');

                await webcam.play();
                document.getElementById("status-log").innerHTML = "✅ 辨識中...";
                
                // 5. 將畫布加入網頁
                document.getElementById("webcam-container").appendChild(webcam.canvas);
                labelContainer = document.getElementById("label");
                confContainer = document.getElementById("conf");

                window.requestAnimationFrame(loop);
            } catch (e) {
                console.error(e);
                document.getElementById("status-log").innerHTML = "錯誤: " + e.message;
                document.getElementById("start-btn").style.display = "inline-block";
            }
        }

        async function loop() {
            webcam.update(); // 每一格影像更新
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            
            // 找出機率最高的結果
            prediction.sort((a, b) => b.probability - a.probability);
            const top = prediction[0];

            // 顯示結果
            labelContainer.innerHTML = top.className;
            confContainer.innerHTML = "辨識準確度: " + (top.probability * 100).toFixed(0) + "%";
            
            // 如果你之後換了大坌坑模型，可以在這裡加入特定文字說明
            if(top.className === "大坌坑") {
                labelContainer.style.color = "#ffeb3b";
            }
        }
    </script>
</body>
</html>